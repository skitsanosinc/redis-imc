/**
 * Created by skitsanos on 18/10/2014.
 */

var url = require('url');
var moment = require('moment');

var _caches = function (request, response, app) {
    var urlParts = url.parse(request.url, true);
    var urlPath = urlParts.pathname.split('/');

    var projectId = urlPath[1];
    var cacheId = urlPath[2];

    switch (request.method) {
        case 'GET':
            switch (cacheId) {
                case '_caches':
                    //get list caches
                    app.api.redis.hget('projects.' + projectId, 'createdBy', function (e, r) {
                        if (r != null) {
                            app.api.redis.keys('caches.' + projectId + '.*', function (err, result) {
                                if (err == null) {
                                    var arr = [];
                                    for (var i = 0; i < result.length; i++) {
                                        arr.push(result[i].replaceAll('caches.' + projectId + '.', ''));
                                    }
                                    app.utils.serveJson('result', arr.sort());
                                }
                                else {

                                    app.utils.serveJson('error', err);
                                }
                            });
                        }
                        else {
                            app.utils.serveJson('error', 'Project {' + projectId + '} does not exist');
                        }
                    });
                    break;

                case '_details': //project details
                    //return here number of items in set
                    app.api.redis.hget('projects.' + projectId, 'createdBy', function (e, r) {
                        if (r != null) {
                            app.api.redis.hlen('projects.' + projectId, function (e_hlen, r_hlen) {
                                if (!e_hlen) {
                                    app.utils.serveJson('result', {caches: r_hlen});
                                }
                                else {
                                    app.utils.serveJson('result', {caches: 0});
                                }
                            });
                        }
                        else {
                            app.utils.serveJson('error', 'Project {' + projectId + '} does not exist');
                        }
                    });
                    break;

                default:
                    app.utils.serveJson('error', 'Not supported');
                    break;
            }
            break;

        case 'PUT':  //add cache
            app.utils.parseRequestBody(function (result) {
                var doc = app.utils.parseJSON(result);
                if (doc == null) {
                    app.utils.serveJson('error', 'Incorrect JSON data');
                }
                else {
                    if (doc.name == undefined) {
                        app.utils.serveJson('error', '{name} parameter is missing');
                    }
                    else {
                        if (doc.name.startsWith('_')) {
                            app.utils.serveJson('error', '{name} cannot start with underscore character (_)');
                        }
                        else {
                            //check if project exists
                            app.api.redis.hget('projects.' + projectId, 'createdBy', function (e, r) {
                                if (r == null) {
                                    app.utils.serveJson('error', 'Project {' + projectId + '} does not exist');
                                }
                                else {
                                    //now when all checks done, final check is to see if we have a project in our data store
                                    app.api.redis.hget('caches.' + projectId + '.' + doc.name, 'createdBy', function (e, r) {
                                        if (r != null) {
                                            app.utils.serveJson('error', 'Cache {' + doc.name + '} already exists');
                                        }
                                        else {
                                            app.api.redis.hset('caches.' + projectId + '.' + doc.name, 'createdBy', '$api', function (e_set, r_set) {
                                                if (r_set == 1) {
                                                    app.utils.serveJson('result', true);
                                                    //set the timestamp of creation
                                                    app.api.redis.hset('caches.' + projectId + '.' + doc.name, 'createdOn', moment().format());
                                                }
                                                else {
                                                    app.utils.serveJson('error', false);
                                                }
                                            });
                                        }
                                    });
                                }
                            });
                        }
                    }
                }
            });
            break;

        case 'DELETE': //delete project
            if (urlPath[1] == '_projects') {
                app.utils.serveJson('error', 'Not allowed');
            }
            else {
                //now when all checks done, final check is to see if we have a project in our data store
                app.api.redis.hget('projects.' + projectId, 'createdBy', function (e, r) {
                    if (r == null) {
                        app.utils.serveJson('error', 'Project {' + urlPath[1] + '} does not exist');
                    }
                    else {
                        //drill-down deletion of items, then caches, and then project

                        //delete project
                        app.api.redis.hget('caches.' + projectId + '.' + cacheId, 'createdBy', function (e_c, r_c) {

                            if (r_c != null) {

                                app.api.redis.del('caches.' + projectId + '.' + cacheId, function (e_set, r_set) {
                                    if (r_set == 1) {
                                        app.utils.serveJson('result', true);
                                    }
                                    else {
                                        app.utils.serveJson('error', false);
                                    }
                                });
                            }
                            else {
                                app.utils.serveJson('error', 'Cache {' + cacheId + '} does not exist');
                            }
                        });
                    }
                });
            }
            break;

        default:
            app.utils.serveError(405, 'Only GET, PUT and DELETE methods are allowed');
            break;
    }
};
module.exports = _caches;